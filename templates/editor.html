<!DOCTYPE html>
<html>
<head>
    <title>InstantNotes - {{ note_id }}</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; overflow: hidden;
        }
        .container { height: 100vh; display: flex; flex-direction: column; }
        .editor-container { flex: 1; display: flex; flex-direction: column; }
        .editor-header { 
            padding: 20px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-secondary { 
            color: white; text-decoration: none; padding: 8px 16px; 
            border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
            background: rgba(255,255,255,0.1);
        }
        .share-section { display: flex; align-items: center; gap: 10px; }
        .share-url { 
            color: rgba(255,255,255,0.8); font-size: 14px; 
            word-break: break-all; max-width: 200px;
        }
        .copy-btn { 
            padding: 6px 12px; border: none; border-radius: 4px; 
            background: #4CAF50; color: white; cursor: pointer;
        }
        #note { 
            flex: 1; border: none; padding: 40px; 
            font-size: 18px; line-height: 1.6; font-family: inherit;
            background: rgba(255,255,255,0.95); resize: none;
            outline: none; color: #333;
        }
        .status { 
            padding: 20px; background: rgba(0,0,0,0.2); 
            display: flex; justify-content: space-between; font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-container">
            <div class="editor-header">
                <a href="/" class="btn-secondary">‚Üê New Note</a>
                <div class="share-section">
                    <strong style="color: white;">Share:</strong>
                    <span class="share-url" id="shareUrl">{{ request.host_url }}{{ note_id }}</span>
                    <button onclick="copyUrl()" class="copy-btn">üìã Copy</button>
                </div>
            </div>
            <textarea id="note" placeholder="Start typing... Changes sync instantly across all open tabs! ‚ú®">{{ existing_content }}</textarea>
            <div class="status">
                <span id="status">Connecting...</span>
                <span id="users" style="color: rgba(255,255,255,0.8);">Live editing enabled</span>
            </div>
        </div>
    </div>

    <script>
        // Global vars
        const noteId = '{{ note_id }}';
        const shareUrl = document.getElementById('shareUrl').textContent;
        const note = document.getElementById('note');
        const status = document.getElementById('status');
        
        // Socket connection
        const socket = io({ 
            transports: ['websocket', 'polling'],
            timeout: 20000 
        });
        
        let updateTimer;
        
        // Events
        socket.on('connect', () => {
            console.log('‚úÖ Socket Connected:', socket.id);
            status.textContent = 'Connected ‚úì';
            socket.emit('join_note', { note_id: noteId });
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected');
            status.textContent = 'Disconnected';
        });
        
        socket.on('status', (data) => {
            console.log('Status:', data.msg);
            status.textContent = data.msg;
        });
        
        socket.on('text_update', (data) => {
            console.log('üì• Update received:', data.content.substring(0, 50) + '...');
            if (Math.abs(note.value.length - data.content.length) > 2) {
                note.value = data.content;  // Only update if significant change
            }
        });
        
        // Typing ‚Üí Debounced emit
        function sendUpdate() {
            const content = note.value;
            clearTimeout(updateTimer);
            updateTimer = setTimeout(() => {
                console.log('üì§ Sending update...');
                socket.emit('text_change', { 
                    note_id: noteId, 
                    content: content 
                });
            }, 250);  // 250ms debounce
        }
        
        note.addEventListener('input', sendUpdate);
        note.addEventListener('paste', sendUpdate);
        note.addEventListener('cut', sendUpdate);
        
        // Copy URL
        function copyUrl() {
            navigator.clipboard.writeText(shareUrl).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = original, 2000);
            });
        }
    </script>
</body>
</html>
